let draggingGrabber=null,startPageX=null,startPageY=null,startLeft=null,startTop=null,startWidth=null,startHeight=null,mouseDownSourceRectX=null,mouseDownSourceRectY=null,mouseDownSourceRectRight=null,mouseDownSourceRectBottom=null,draggableImageMouseDown=!1,draggableImageLeft=null,draggableImageTop=null,draggableImageStartX=null,draggableImageStartY=null,sourceRectLeft=0,sourceRectTop=0,sourceRectRight=0,sourceRectBottom=0,arWidth=1,arHeight=1,mouseDownAspectRatioWidth=arWidth,mouseDownAspectRatioHeight=arHeight,theCanvas=null,theContext=null,maskCanvas=null,maskCanvasContext=null,bgCanvas=document.createElement("canvas"),bgContext=bgCanvas.getContext("2d"),undoStack=[],redoStack=[],resizeType="crop",workingImageElem=null,seamCarverWorker=new Worker("worker.js"),pxImage=null,hSeamMatrix=null,vSeamMatrix=null,hSeamsAdded=0,vSeamsAdded=0;function onGrabberMouseDown(e,t,a){e.preventDefault(),e.stopPropagation(),draggingGrabber=a,startPageX=e.pageX,startPageY=e.pageY,startLeft=t.offsetLeft,startTop=t.offsetTop,startWidth=t.offsetWidth,startHeight=t.offsetHeight,mouseDownSourceRectX=sourceRectLeft,mouseDownSourceRectY=sourceRectTop,mouseDownSourceRectRight=sourceRectRight,mouseDownSourceRectBottom=sourceRectBottom,mouseDownAspectRatioWidth=arWidth,mouseDownAspectRatioHeight=arHeight}function createGrabberHandler(e,t,a){let r=document.querySelector(e);r.addEventListener("mousedown",e=>{pushCurrentStateToUndoStack(),onGrabberMouseDown(e,t,a)}),r.addEventListener("touchstart",e=>{pushCurrentStateToUndoStack(),onGrabberMouseDown(e,t,a)},{passive:!0})}function setTextBoxValue(e,t){let a=document.querySelector(e);a&&(a.textContent=t)}function updateDimensions(){document.querySelector(".ac-bia-label-size").textContent="PNG - "+theCanvas.width+" x "+theCanvas.height}function handleUserEditDimensionInput(e,t){let a=+e;isNaN(a)||(t(a),redraw())}function stopPropagation(e){e.stopPropagation()}function handleDimensionInputChange(e,t){let a=document.querySelector(e);a.addEventListener("mousedown",stopPropagation),a.addEventListener("touchstart",stopPropagation,{passive:!0}),a.addEventListener("keypress",e=>{13===e.which&&(e.preventDefault(),handleUserEditDimensionInput(e.target.textContent,t))}),a.addEventListener("focusout",e=>{handleUserEditDimensionInput(e.target.textContent,t)})}function handleDimensionWheelChange(e,t){let a=e=>{e.ctrlKey||(e.deltaY<0?(t(1),redraw()):e.deltaY>0&&(t(-1),redraw()))};for(let t of e)document.querySelector(t).addEventListener("wheel",a,{passive:!0})}function getIncrementedAspectRatioPercent(e,t){return Math.ceil(Math.round(100*e)+t)}function applyMouseWheelScale(e,t){if(!isNaN(e)){let t=getIncrementedAspectRatioPercent(arWidth,e);arWidth=t/100,document.querySelector(".ac-fi-width-scale").textContent=t}if(!isNaN(t)){let e=getIncrementedAspectRatioPercent(arHeight,t);arHeight=e/100,document.querySelector(".ac-fi-height-scale").textContent=e}}function applyMouseWheelCarve(e,t){isNaN(e)||(vSeamsAdded+=e,document.querySelector(".ac-fi-width-carve").textContent=seamsToPercent(vSeamsAdded,bgCanvas.width)),isNaN(t)||(hSeamsAdded+=t,document.querySelector(".ac-fi-height-carve").textContent=seamsToPercent(hSeamsAdded,bgCanvas.height))}function applyMouseWheelCrop(e,t,a,r){isNaN(e)||(sourceRectTop+=e,document.querySelector(".ac-fi-top").textContent=Math.round(sourceRectTop),setCanvasTop(sourceRectTop)),isNaN(t)||(sourceRectRight+=t,document.querySelector(".ac-fi-right").textContent=Math.round(sourceRectRight)),isNaN(a)||(sourceRectBottom+=a,document.querySelector(".ac-fi-bottom").textContent=Math.round(sourceRectBottom)),isNaN(r)||(sourceRectLeft+=r,document.querySelector(".ac-fi-left").textContent=Math.round(sourceRectLeft),setCanvasLeft(sourceRectLeft))}function createDimensionHandlers(){handleDimensionInputChange(".ac-fi-left",e=>{sourceRectLeft=e,setCanvasLeft(e)}),handleDimensionInputChange(".ac-fi-top",e=>{sourceRectTop=e,setCanvasTop(e)}),handleDimensionInputChange(".ac-fi-right",e=>{sourceRectRight=e}),handleDimensionInputChange(".ac-fi-bottom",e=>{sourceRectBottom=e}),handleDimensionInputChange(".ac-fi-width-scale",e=>{arWidth=e/100}),handleDimensionInputChange(".ac-fi-height-scale",e=>{arHeight=e/100}),handleDimensionInputChange(".ac-fi-width-carve",e=>{vSeamsAdded=Math.floor(bgCanvas.width*(e/100)-bgCanvas.width)}),handleDimensionInputChange(".ac-fi-height-carve",e=>{hSeamsAdded=Math.floor(bgCanvas.height*(e/100)-bgCanvas.height)}),handleDimensionWheelChange([".grabber-w",".sc-left"],e=>{"crop"===resizeType?applyMouseWheelCrop(null,null,null,e):"scale"===resizeType?applyMouseWheelScale(e,null):"carve"===resizeType&&applyMouseWheelCarve(e,null)}),handleDimensionWheelChange([".grabber-n",".sc-top",".sc-height-scale",".sc-height-carve"],e=>{"crop"===resizeType?applyMouseWheelCrop(e,null,null,null):"scale"===resizeType?applyMouseWheelScale(null,e):"carve"===resizeType&&applyMouseWheelCarve(null,e)}),handleDimensionWheelChange([".grabber-e",".sc-right",".sc-width-scale",".sc-width-carve"],e=>{"crop"===resizeType?applyMouseWheelCrop(null,e,null,null):"scale"===resizeType?applyMouseWheelScale(e,0):"carve"===resizeType&&applyMouseWheelCarve(e,0)}),handleDimensionWheelChange([".grabber-s",".sc-bottom"],e=>{"crop"===resizeType?applyMouseWheelCrop(null,null,e,null):"scale"===resizeType?applyMouseWheelScale(null,e):"carve"===resizeType&&applyMouseWheelCarve(null,e)}),handleDimensionWheelChange([".grabber-se"],e=>{"crop"===resizeType?applyMouseWheelCrop(null,e,e,null):"scale"===resizeType?applyMouseWheelScale(e,e):"carve"===resizeType&&applyMouseWheelCarve(e,e)}),handleDimensionWheelChange([".grabber-sw"],e=>{"crop"===resizeType?applyMouseWheelCrop(null,null,-e,e):"scale"===resizeType?applyMouseWheelScale(e,e):"carve"===resizeType&&applyMouseWheelCarve(e,e)}),handleDimensionWheelChange([".grabber-nw"],e=>{"crop"===resizeType?applyMouseWheelCrop(e,null,null,e):"scale"===resizeType?applyMouseWheelScale(e,e):"carve"===resizeType&&applyMouseWheelCarve(e,e)}),handleDimensionWheelChange([".grabber-ne"],e=>{"crop"===resizeType?applyMouseWheelCrop(-e,e,null,null):"scale"===resizeType?applyMouseWheelScale(e,e):"carve"===resizeType&&applyMouseWheelCarve(e,e)})}function getPageWidth(){return Math.max(document.body.scrollWidth,document.body.offsetWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth)}function getPageHeight(){return Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight)}let draggableImagePointerDownHandler=e=>{let t=document.querySelector(".draggable-image");draggableImageMouseDown=!0,draggableImageLeft=t.offsetLeft,draggableImageTop=t.offsetTop,draggableImageStartX=e.pageX,draggableImageStartY=e.pageY},draggleImagePointerMoveHandler=e=>{let t=document.querySelector(".draggable-image");draggableImageMouseDown&&!imageMaskVisible&&(t.style.left=draggableImageLeft-(draggableImageStartX-e.pageX)+"px",t.style.top=draggableImageTop-(draggableImageStartY-e.pageY)+"px")},pointerMoveHandler=e=>{draggingGrabber&&(e.preventDefault(),"crop"===resizeType?executeDrawFunctionCrop(e):"scale"===resizeType?executeDrawFunctionScale(e):"carve"===resizeType&&executeDrawFunctionCarve(e),setFieldValues())};function pointerUpHandler(e){draggingGrabber=null,draggableImageMouseDown=!1,markerLineMouseDown=!1}function preventMaskRightClick(e){return e.preventDefault(),!1}function initializeApp(){theCanvas=document.querySelector(".my-canvas"),theContext=theCanvas.getContext("2d"),maskCanvas=document.querySelector(".mask-canvas"),maskCanvasContext=maskCanvas.getContext("2d"),workingImageElem=document.querySelector(".working-image");let e=document.querySelector(".draggable-image");e.addEventListener("mousedown",draggableImagePointerDownHandler),e.addEventListener("touchstart",draggableImagePointerDownHandler,{passive:!0}),e.addEventListener("mousemove",draggleImagePointerMoveHandler),e.addEventListener("touchmove",draggleImagePointerMoveHandler,{passive:!0}),document.querySelector(".mask-canvas").oncontextmenu=preventMaskRightClick,createDimensionHandlers(),createGrabberHandler(".grabber-n",workingImageElem,"n"),createGrabberHandler(".grabber-ne",workingImageElem,"ne"),createGrabberHandler(".grabber-e",workingImageElem,"e"),createGrabberHandler(".grabber-se",workingImageElem,"se"),createGrabberHandler(".grabber-s",workingImageElem,"s"),createGrabberHandler(".grabber-sw",workingImageElem,"sw"),createGrabberHandler(".grabber-w",workingImageElem,"w"),createGrabberHandler(".grabber-nw",workingImageElem,"nw"),document.addEventListener("mousemove",pointerMoveHandler),document.addEventListener("touchmove",pointerMoveHandler),document.addEventListener("mouseup",pointerUpHandler),document.addEventListener("touchend",pointerUpHandler),showStatItemsWhenSelected()}function showStatItemsWhenSelected(){let e=document.querySelectorAll(".stat-item-text");for(let t of e)t.addEventListener("focus",e=>{e.target.parentNode.classList.add("stat-item-text-visible")}),t.addEventListener("blur",e=>{e.target.parentNode.classList.remove("stat-item-text-visible")})}function getZoomLevelWhichFitsImage(e,t){let a=window.innerWidth/e,r=window.innerHeight/t,o=1;if(a<1)for(let e=0;e<zoomLevels.length;e++)zoomLevels[e]<a&&(o=zoomLevels[e]);if(r<1)for(let e=0;e<zoomLevels.length;e++)zoomLevels[e]<r&&(o=zoomLevels[e]);return o}function setupInteractiveImage(e){selectResize("crop");let t=e.width,a=e.height;bgCanvas.width=t,bgCanvas.height=e.height,maskImageData=new ImageData(t,a),prevMaskImageData=new ImageData(t,a),bgContext.drawImage(e,0,0),updateDimensions(),sourceRectLeft=0,sourceRectTop=0,sourceRectRight=0,sourceRectBottom=0,arWidth=1,arHeight=1;getZoomLevelWhichFitsImage(t,a);updateZoomLevel(1);let r=getPageWidth()/2-t/2-137.5,o=getPageHeight()/2-a/2,n=document.querySelector(".draggable-image");n.style.left=r+"px",n.style.top=o+"px",setTextBoxValue(".ac-fi-top",0),setTextBoxValue(".ac-fi-left",0),setTextBoxValue(".ac-fi-right",0),setTextBoxValue(".ac-fi-bottom",0),redraw(),showEditingInterface(),setupMaskCanvasHandlers(),pxImage=theContext.getImageData(0,0,theCanvas.width,theCanvas.height),seamCarverWorker.postMessage({pixels:pxImage,mask:getUint32View(maskImageData)}),hSeamMatrix=new Uint32Array(t*a).fill(999999),vSeamMatrix=new Uint32Array(t*a).fill(999999);let s=0;seamCarverWorker.onmessage=function(e){let r=new Uint32Array(e.data),o=r[0];for(let e=1;e<r.length;e+=2){let t=r[e],a=r[e+1];0===o?vSeamMatrix[t]=a:hSeamMatrix[t]=a}updateCompletion(s+=1,t,a)}}function updateCompletion(e,t,a){let r=e/(t+a),o=Math.floor(100*r);document.querySelector(".ac-rir-processing").textContent="Processing: "+o+"%",100===o&&(document.querySelector(".ac-rir-processing").style.display="none",redraw())}function seamsToPercent(e,t){return Math.floor((t+e)/t*100)}function setFieldValues(){setTextBoxValue(".ac-fi-top",Math.round(sourceRectTop)),setTextBoxValue(".ac-fi-left",Math.round(sourceRectLeft)),setTextBoxValue(".ac-fi-right",Math.round(sourceRectRight)),setTextBoxValue(".ac-fi-bottom",Math.round(sourceRectBottom)),setTextBoxValue(".ac-fi-width-scale",Math.round(100*arWidth)),setTextBoxValue(".ac-fi-height-scale",Math.round(100*arHeight)),setTextBoxValue(".ac-fi-width-carve",seamsToPercent(vSeamsAdded,bgCanvas.width)),setTextBoxValue(".ac-fi-height-carve",seamsToPercent(hSeamsAdded,bgCanvas.height))}function setSourceRect(e){null!=e.left&&(sourceRectLeft=e.left),null!=e.top&&(sourceRectTop=e.top),null!=e.right&&(sourceRectRight=e.right),null!=e.bottom&&(sourceRectBottom=e.bottom)}function getNewSourceRectParams(e,t){let a=(startPageX-e)/arWidth,r=(startPageY-t)/arHeight,o=mouseDownSourceRectRight-a,n=mouseDownSourceRectBottom-r,s=mouseDownSourceRectX-a,i=mouseDownSourceRectY-r;switch(draggingGrabber){case"n":return{top:i};case"ne":return{top:i,right:o};case"e":return{right:o};case"se":return{right:o,bottom:n};case"s":return{bottom:n};case"sw":return{left:s,bottom:n};case"w":return{left:s};case"nw":return{left:s,top:i}}return{}}function setCanvasPosition(e,t){let a=startLeft-(startPageX-e),r=startTop-(startPageY-t);switch(draggingGrabber){case"n":case"ne":setCanvasTop(r);break;case"sw":case"w":setCanvasLeft(a);break;case"nw":setCanvasLeft(a),setCanvasTop(r)}}function maybeHandleShiftScale(e){if(!e)return;let t=Math.max(arWidth,arHeight);arWidth=t,arHeight=t}function maybeHandleShiftCrop(e){if(!e)return;let t=sourceRectLeft,a=sourceRectTop,r=sourceRectRight,o=sourceRectBottom,n=Math.max(-a,r),s=Math.max(o,r),i=Math.max(o,-t),c=Math.max(-a,-t);"se"===draggingGrabber?(sourceRectBottom=s,sourceRectRight=s):"sw"===draggingGrabber?(sourceRectBottom=i,setCanvasLeft(sourceRectLeft=-i)):"nw"===draggingGrabber?(sourceRectTop=-c,setCanvasLeft(sourceRectLeft=-c),setCanvasTop(sourceRectTop)):"ne"===draggingGrabber&&(sourceRectRight=n,setCanvasTop(sourceRectTop=-n))}function executeDrawFunctionCrop(e){setSourceRect(getNewSourceRectParams(e.pageX,e.pageY)),setCanvasPosition(e.pageX,e.pageY),maybeHandleShiftCrop(e.shiftKey),redraw()}function executeDrawFunctionScale(e){setCanvasPosition(e.pageX,e.pageY);let t=getNewCanvasSize(e.pageX,e.pageY);arWidth=mouseDownAspectRatioWidth*(t.width/startWidth),arHeight=mouseDownAspectRatioHeight*(t.height/startHeight),maybeHandleShiftScale(e.shiftKey),redraw()}function executeDrawFunctionCarve(e){setCanvasPosition(e.pageX,e.pageY);let t=getNewCanvasSize(e.pageX,e.pageY),a=bgCanvas.width-sourceRectLeft+sourceRectRight,r=bgCanvas.height-sourceRectTop+sourceRectBottom,o=Math.ceil(a*arWidth),n=Math.ceil(r*arHeight);vSeamsAdded=Math.ceil((t.width-o)/arWidth),hSeamsAdded=Math.ceil((t.height-n)/arHeight),redraw()}function getNewCanvasSize(e,t){let a=startWidth-(startPageX-e),r=startHeight-(startPageY-t),o=startWidth-(e-startPageX),n=startHeight-(t-startPageY);switch(draggingGrabber){case"n":return{width:startWidth,height:n};case"ne":return{width:a,height:n};case"e":return{width:a,height:startHeight};case"se":return{width:a,height:r};case"s":return{width:startWidth,height:r};case"sw":return{width:o,height:r};case"w":return{width:o,height:startHeight};case"nw":return{width:o,height:n}}return{width:startWidth,height:startHeight}}function test(){let e=changeSeams(50,50);bgCanvas.width=e.width,bgCanvas.height=e.height,bgContext.putImageData(e,0,0),redraw()}function changeSeams(e,t){let a=pxImage,r=a.width,o=a.height,n=r+e,s=new ImageData(n,o+t),i=new Uint32Array(a.data.buffer),c=new Uint32Array(s.data.buffer),l=new Int32Array(r),u=-e,g=-t,d=e<0,m=t<0,h=e>0,p=t>0;for(let a=0;a<o;a++){let o=a*r,s=0;for(let f=0;f<r;f++){let r=o+f,v=h&&vSeamMatrix[r]<e,C=p&&hSeamMatrix[r]<t,w=a+l[f],b=f+s;if(c[w*n+b]=i[r],v){c[w*n+b+1]=i[r],s+=1}if(C){c[(w+1)*n+b]=i[r],l[f]+=1}if(v&&C){c[(w+1)*n+b+1]=i[r]}d&&vSeamMatrix[r]<u&&(s-=1),m&&hSeamMatrix[r]<g&&(l[f]-=1)}}for(let e=0;e<c.length;e++)0===c[e]&&(c[e]=c[e-1]);return s}function redraw(){let e=bgCanvas.width,t=bgCanvas.height,a=bgCanvas,r=imageMaskVisible?1:arWidth,o=imageMaskVisible?1:arHeight;if(!imageMaskVisible&&(0!==vSeamsAdded||0!==hSeamsAdded)){let r=changeSeams(vSeamsAdded,hSeamsAdded);e=r.width,t=r.height;let o=createTempCanvas(),n=o.getContext("2d");o.width=e,o.height=t,n.putImageData(r,0,0),a=o}let n=e-sourceRectLeft+sourceRectRight,s=t-sourceRectTop+sourceRectBottom;theCanvas.width=Math.ceil(n*r),theCanvas.height=Math.ceil(s*o);let i=sourceRectLeft<0?-sourceRectLeft:0,c=sourceRectTop<0?-sourceRectTop:0,l=sourceRectLeft+i,u=sourceRectTop+c,g=e-(sourceRectLeft>0?sourceRectLeft:0)+(sourceRectRight<0?sourceRectRight:0),d=t-(sourceRectTop>0?sourceRectTop:0)+(sourceRectBottom<0?sourceRectBottom:0),m=Math.ceil(g*r),h=Math.ceil(d*o),p=i*r,f=c*o;maskCanvas.width=theCanvas.width,maskCanvas.height=theCanvas.height,imageMaskVisible&&maskCanvasContext.putImageData(maskImageData,0,0),theContext.drawImage(a,l,u,g,d,p,f,m,h),updateDimensions()}function setCanvasTop(e){workingImageElem.style.top=e+"px"}function setCanvasLeft(e){workingImageElem.style.left=e+"px"}function saveCanvasToFile(){let e=theCanvas.toDataURL("image/png").replace("image/png","image/octet-stream"),t=document.getElementById("link");t.setAttribute("download","resized.png"),t.setAttribute("href",e),t.click()}function selectResize(e){let t=document.querySelectorAll(".ac-resize-item-radio");for(let e of t)e.classList.remove("ac-rir-selected");let a=document.querySelectorAll(".ac-image-actions");for(let e of a)e.classList.remove("ac-image-actions-visible");workingImageElem.classList.remove("wi-crop"),workingImageElem.classList.remove("wi-scale"),workingImageElem.classList.remove("wi-carve"),resizeType=e,"crop"===e?(workingImageElem.classList.add("wi-crop"),document.querySelector(".ac-image-actions-crop").classList.add("ac-image-actions-visible"),document.querySelector(".ac-rir-crop").classList.add("ac-rir-selected")):"scale"===e?(workingImageElem.classList.add("wi-scale"),document.querySelector(".ac-image-actions-scale").classList.add("ac-image-actions-visible"),document.querySelector(".ac-rir-scale").classList.add("ac-rir-selected")):"carve"===e&&(workingImageElem.classList.add("wi-carve"),document.querySelector(".ac-image-actions-carve").classList.add("ac-image-actions-visible"),document.querySelector(".ac-rir-carve").classList.add("ac-rir-selected"))}let KEYS={SHIFT:16,CONTROL:17,ALT:18,Q:81,W:87,A:65,S:83,D:68,F:70,Y:89,Z:90,MINUS:189,EQUALS:187};function handleMouseWheel(e){if(!e.ctrlKey)return;e.preventDefault();let t=(e.deltaY||-e.wheelDelta||e.detail)>>10||1;t>0?zoomCanvasOut():t<0&&zoomCanvasIn()}function createCurrentStateObject(){return{image:bgCanvas,sourceRectLeft:sourceRectLeft,sourceRectTop:sourceRectTop,sourceRectRight:sourceRectRight,sourceRectBottom:sourceRectBottom,arWidth:arWidth,arHeight:arHeight}}function pushCurrentStateToUndoStack(){let e=createCurrentStateObject();undoStack.push(e),redoStack=[]}function setLiveStateToThisState(e){sourceRectLeft=e.sourceRectLeft,sourceRectTop=e.sourceRectTop,sourceRectRight=e.sourceRectRight,sourceRectBottom=e.sourceRectBottom,arWidth=e.arWidth,arHeight=e.arHeight,bgCanvas=e.image,setCanvasLeft(sourceRectLeft),setCanvasTop(sourceRectTop)}function undoLastAction(){if(undoStack.length<=0)return;redoStack.push(createCurrentStateObject()),setLiveStateToThisState(undoStack.pop()),setFieldValues(),redraw()}function redoLastAction(){if(redoStack.length<=0)return;undoStack.push(createCurrentStateObject()),setLiveStateToThisState(redoStack.pop()),setFieldValues(),redraw()}function createTempCanvas(){let e=document.createElement("canvas");return e.width=bgCanvas.width,e.height=bgCanvas.height,e}function imageAutoCrop(){pushCurrentStateToUndoStack();let e=createTempCanvas().getContext("2d");e.drawImage(bgCanvas,0,0,bgCanvas.width,bgCanvas.height);let t=bgCanvas.width+1,a=bgCanvas.height+1,r=e.getImageData(0,0,t,a),o=r.data[0],n=r.data[1],s=r.data[2],i=bgCanvas.width,c=bgCanvas.height,l=-1,u=-1,g=Math.max(sourceRectLeft,0),d=Math.max(sourceRectTop,0),m=Math.min(sourceRectRight,0),h=Math.min(sourceRectBottom,0),p=bgCanvas.width-m+1,f=bgCanvas.height-h+1;for(y=d;y<f;y++)for(x=g;x<p;x++){let e=4*(y*t+x);o===r.data[e+0]&&n===r.data[e+1]&&s===r.data[e+2]||(x<i&&(i=x),y<c&&(c=y),x>l&&(l=x),y>u&&(u=y))}sourceRectLeft=i,sourceRectTop=c,sourceRectRight=bgCanvas.width-l,sourceRectBottom=bgCanvas.height-u,setCanvasLeft(sourceRectLeft),setCanvasTop(sourceRectTop),setFieldValues(),redraw()}function imageFlipHorizontally(){pushCurrentStateToUndoStack();let e=createTempCanvas(),t=e.getContext("2d");t.translate(bgCanvas.width,0),t.scale(-1,1),t.drawImage(bgCanvas,0,0),pxImage=t.getImageData(0,0,bgCanvas.width,bgCanvas.height),bgCanvas=e,bgContext=t;let a=sourceRectLeft;sourceRectLeft=-sourceRectRight,sourceRectRight=-a,vSeamMatrix&&(vSeamMatrix=flipArrayHorizontally(vSeamMatrix,bgCanvas.width,bgCanvas.height)),hSeamMatrix&&(hSeamMatrix=flipArrayHorizontally(hSeamMatrix,bgCanvas.width,bgCanvas.height));let r=new Uint32Array(maskImageData.data.buffer),o=new Uint8ClampedArray(flipArrayHorizontally(r,bgCanvas.width,bgCanvas.height).buffer);maskImageData=new ImageData(o,bgCanvas.width,bgCanvas.height),setPrevMaskImageData(),redraw()}function imageFlipVertically(){pushCurrentStateToUndoStack();let e=createTempCanvas(),t=e.getContext("2d");t.translate(0,bgCanvas.height),t.scale(1,-1),t.drawImage(bgCanvas,0,0),pxImage=t.getImageData(0,0,bgCanvas.width,bgCanvas.height),bgCanvas=e,bgContext=t;let a=sourceRectTop;sourceRectTop=-sourceRectBottom,sourceRectBottom=-a,vSeamMatrix&&(vSeamMatrix=flipArrayVertically(vSeamMatrix,bgCanvas.width,bgCanvas.height)),hSeamMatrix&&(hSeamMatrix=flipArrayVertically(hSeamMatrix,bgCanvas.width,bgCanvas.height));let r=new Uint32Array(maskImageData.data.buffer),o=new Uint8ClampedArray(flipArrayVertically(r,bgCanvas.width,bgCanvas.height).buffer);maskImageData=new ImageData(o,bgCanvas.width,bgCanvas.height),setPrevMaskImageData(),redraw()}function imageRotate(){pushCurrentStateToUndoStack();let e=createTempCanvas(),t=e.getContext("2d"),a=pxImage.width,r=pxImage.height;e.width=bgCanvas.height,e.height=bgCanvas.width,t.translate(bgCanvas.height,0),t.rotate(90*Math.PI/180),t.drawImage(bgCanvas,0,0),pxImage=t.getImageData(0,0,e.width,e.height);let o=sourceRectTop,n=sourceRectRight,s=sourceRectBottom;sourceRectTop=sourceRectLeft,sourceRectRight=-o,sourceRectBottom=n,sourceRectLeft=-s;let i=arWidth;arWidth=arHeight,arHeight=i,setFieldValues(),bgCanvas=e,bgContext=t;let c=vSeamMatrix,l=hSeamsAdded;hSeamsAdded=vSeamsAdded,vSeamsAdded=l,vSeamMatrix&&(vSeamMatrix=rotateArray(hSeamMatrix,a,r)),hSeamMatrix&&(hSeamMatrix=rotateArray(c,a,r));let u=new Uint32Array(maskImageData.data.buffer),g=new Uint8ClampedArray(rotateArray(u,a,r).buffer);maskImageData=new ImageData(g,e.width,e.height),setPrevMaskImageData(),redraw()}function imageOriginalCrop(){pushCurrentStateToUndoStack(),sourceRectTop=0,sourceRectRight=0,sourceRectBottom=0,setCanvasLeft(sourceRectLeft=0),setCanvasTop(sourceRectTop),setFieldValues(),redraw()}function imageOriginalScale(){pushCurrentStateToUndoStack(),arWidth=1,arHeight=1,setCanvasLeft(sourceRectLeft),setCanvasTop(sourceRectTop),setFieldValues(),redraw()}function imageOriginalCarve(){pushCurrentStateToUndoStack(),vSeamsAdded=0,hSeamsAdded=0,setCanvasLeft(sourceRectLeft),setCanvasTop(sourceRectTop),setFieldValues(),redraw()}function showEditingInterface(){document.querySelector(".splash-interface").classList.add("display-none"),document.querySelector(".editing-interface").classList.remove("zero-opacity")}function hideEditingInterface(){document.querySelector(".splash-interface").classList.remove("display-none"),document.querySelector(".editing-interface").classList.add("zero-opacity")}function processFileIntoImage(e){let t=new Image;t.onload=function(){setupInteractiveImage(t)},t.src=URL.createObjectURL(e)}function preventDefault(e){e.preventDefault()}function pageLoaded(){initializeApp();let e=document.querySelector(".drop-image"),t=document.querySelector("body");t.ondragover=preventDefault,t.ondragenter=preventDefault,e.ondragover=function(e){document.querySelector(".drop-image-dashed-container").classList.add("drop-image-dragging"),e.preventDefault()},e.ondragenter=function(e){document.querySelector(".drop-image-dashed-container").classList.add("drop-image-dragging"),e.preventDefault()},e.ondragleave=function(e){document.querySelector(".drop-image-dashed-container").classList.remove("drop-image-dragging"),e.preventDefault()},e.ondragend=function(e){document.querySelector(".drop-image-dashed-container").classList.remove("drop-image-dragging"),e.preventDefault()},document.querySelector("body").ondrop=function(e){if(e.dataTransfer.files.length>0){processFileIntoImage(e.dataTransfer.files[0])}else e.dataTransfer.items.length>0&&e.dataTransfer.items[0].getAsString(e=>{loadImageFromURL(e)});e.preventDefault()}}function browseForImage(){let e=document.createElement("input");e.accept="image/*",e.type="file",e.onchange=(e=>{processFileIntoImage(e.target.files[0])}),e.click()}function loadImageFromURL(e){let t=new Image;t.crossOrigin="Anonymous",t.onload=function(){setupInteractiveImage(t)},t.src=e}function imagePasteTextChanged(e){loadImageFromURL(e.target.value)}function clickSampleImage(e){loadImageFromURL(e.target.currentSrc)}function goBack(){window.location.reload()}document.addEventListener("wheel",handleMouseWheel,{passive:!1}),document.addEventListener("keydown",function(e){workingImageElem&&(e.ctrlKey&&e.keyCode===KEYS.MINUS&&(e.preventDefault(),zoomCanvasOut()),e.ctrlKey&&e.keyCode===KEYS.EQUALS&&(e.preventDefault(),zoomCanvasIn()),e.ctrlKey&&e.keyCode===KEYS.EQUALS&&e.preventDefault(),e.keyCode===KEYS.Z&&e.ctrlKey&&undoLastAction(),e.keyCode===KEYS.Y&&e.ctrlKey&&redoLastAction())}),window.addEventListener("paste",function(e){let t=Array.from(e.clipboardData.items).find(e=>/^image\//.test(e.type));t&&processFileIntoImage(t.getAsFile())});let zoomLevel=1,zoomLevels=[.01,.0125,.025,.0325,.05,.125,.25,.333333,.5,.666667,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3,4,5,6,8,16];function convertFloatToPercent(e){return Math.floor(100*e)+"%"}function getNextLargestZoom(){for(let e=0;e<zoomLevels.length;e++)if(zoomLevels[e]>zoomLevel)return zoomLevels[e];return zoomLevel}function getNextSmallestZoom(){for(let e=zoomLevels.length-1;e>0;e--)if(zoomLevels[e]<zoomLevel)return zoomLevels[e];return zoomLevel}function zoomCanvasOut(){updateZoomLevel(getNextSmallestZoom())}function zoomCanvasReset(){updateZoomLevel(1)}function zoomCanvasIn(){updateZoomLevel(getNextLargestZoom())}function updateZoomLevel(e){let t=convertFloatToPercent(zoomLevel=e);document.documentElement.style.setProperty("--canvas-zoom",zoomLevel),document.querySelector(".canvas-zoom-label").textContent=t}let maskingTool="protect",maskingToolMouseDown=!1,imageMaskVisible=!1;function toggleMask(){document.querySelector(".mask-canvas").classList.remove("allow-mask-input"),imageMaskVisible?(document.querySelector(".ac-button-mask-toggle").querySelector(".ac-bia-label").textContent="Edit Mask",document.querySelector(".ac-button-mask-toggle .ac-ia-svg").innerHTML='<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>',document.querySelector(".ac-mask-options").classList.remove("ac-mask-options-visible"),applyNewMask()):(document.querySelector(".ac-button-mask-toggle").querySelector(".ac-bia-label").textContent="Apply Mask",document.querySelector(".ac-button-mask-toggle .ac-ia-svg").innerHTML='<polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>',document.querySelector(".mask-canvas").classList.add("allow-mask-input"),document.querySelector(".ac-mask-options").classList.add("ac-mask-options-visible")),imageMaskVisible=!imageMaskVisible,redraw()}function clearMask(){let e=new Uint32Array(maskImageData.data.buffer);for(let t=0;t<e.length;t++)e[t]=0;maskCanvasContext.putImageData(maskImageData,0,0)}function setupMaskCanvasHandlers(){let e=document.querySelector(".mask-canvas");e.addEventListener("mousedown",maskingCanvasMouseDown),e.addEventListener("mousemove",maskingCanvasMouseMove),e.addEventListener("mouseup",maskingCanvasMouseUp)}function maskingCanvasMouseDown(e){imageMaskVisible&&(maskingToolMouseDown=!0,paintMask(e.offsetX,e.offsetY))}function getMaskingToolMarkColor(){switch(maskingTool){case"protect":return 2516647680;case"remove":return 2516582655;case"clear":default:return 0}}let maskMarkerRadius=10,maskImageData=null,prevMaskImageData=null;function paintMask(e,t){let a=new Uint32Array(maskImageData.data.buffer),r=getMaskingToolMarkColor(),o=maskMarkerRadius,n=theCanvas.width;for(let s=-o;s<=o;s++)for(let i=-o;i<=o;i++){if(i+e>=0&&i+e<n&&i*i+s*s<=o*o){a[n*(t+s)+(e+i)]=r}}maskCanvasContext.putImageData(maskImageData,0,0)}function maskingCanvasMouseMove(e){imageMaskVisible&&maskingToolMouseDown&&(e.stopPropagation(),paintMask(e.offsetX,e.offsetY))}function getUint32View(e){return new Uint32Array(e.data.buffer)}function isNewMaskDifferent(){if(!prevMaskImageData)return!0;if(prevMaskImageData===maskImageData)return!1;for(let e=0;e<maskImageData.data.length;e++)if(maskImageData.data[e]!==prevMaskImageData.data[e])return!0;return!1}function applyNewMask(){isNewMaskDifferent()&&(document.querySelector(".ac-rir-processing").style.display="block",seamCarverWorker.postMessage({pixels:pxImage,mask:getUint32View(maskImageData)}),redraw(),setPrevMaskImageData())}function setPrevMaskImageData(){prevMaskImageData=new ImageData(new Uint8ClampedArray(maskImageData.data),maskImageData.width,maskImageData.height)}function maskingCanvasMouseUp(e){maskingToolMouseDown&&(maskingToolMouseDown=!1)}function flipArrayHorizontally(e,t,a){let r=new Uint32Array(t*a);for(let o=0;o<a;o++){let a=(o+1)*t-1;for(let n=0;n<t;n++){r[o*t+n]=e[a-n]}}return r}function flipArrayVertically(e,t,a){let r=new Uint32Array(t*a);for(let o=0;o<t;o++)for(let n=0;n<a;n++){let s=(a-n-1)*t+o;r[n*t+o]=e[s]}return r}function rotateArray(e,t,a){let r=new Uint32Array(t*a),o=0;for(let n=0;n<t;n++)for(let s=a-1;s>=0;s--){let a=s*t+n;r[o]=e[a],o++}return r}function useProtectionMarker(){maskingTool="protect"}function useClearMarker(){maskingTool="clear"}function useRemovalMarker(){maskingTool="remove"}function toggleMarker(){let e=document.querySelector(".ac-button-marker");"protect"===maskingTool?(maskingTool="clear",e.querySelector("span").textContent="Clear Marker",e.querySelector("svg").innerHTML='<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>'):"clear"===maskingTool?(maskingTool="remove",e.querySelector("span").textContent="Removal Marker",e.querySelector("svg").innerHTML='<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>'):(maskingTool="protect",e.querySelector("span").textContent="Protection Marker",e.querySelector("svg").innerHTML='<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>')}let markerLineMouseDown=!1,markerSizeLineStartX=null;function clickMarkerSizeLineMouseDown(e){markerLineMouseDown=!0,markerSizeLineStartX=e.clientX,clickMarkerSizeLineMouseMove(e)}function clickMarkerSizeLineMouseUp(){markerLineMouseDown=!1}function clamp(e,t,a){return e<t?t:e>a?a:e}function mapRange(e,t,a,r,o){return Math.floor((e-t)*(o-r)/(a-t))+r}function clickMarkerSizeLineMouseMove(e){if(!markerLineMouseDown)return;let t=clamp(e.clientX-document.querySelector(".marker-size-slider-container").offsetLeft,0,200),a=mapRange(t,0,200,0,50),r=t-document.querySelector(".marker-size-grabber").clientWidth/2;document.querySelector(".marker-size-amount-value").textContent=a,document.querySelector(".marker-size-grabber").style.left=r+"px",maskMarkerRadius=a}
