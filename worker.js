function generateNewSeamCarver(e,t){let r=e.width,n=e.height,a=(performance.now(),getGreyscale(e)),i=getForwardEnergyPixels(a,t,r,n),l=rotateGradientImage(t,r,n),o=rotateGradientImage(a,r,n,"uint8"),f=getForwardEnergyPixels(o,l,n,r,"uint32");calculateSeamMatrix(i,a,t,r,n,0);performance.now();calculateSeamMatrix(f,o,l,n,r,1)}function rotateGradientImage(e,t,r,n){let a="uint8"===n?new Uint8Array(t*r):new Uint32Array(t*r),i=0;for(let n=0;n<t;n++)for(let l=r-1;l>=0;l--){let r=l*t+n;a[i]=e[r],i++}return a}function rotateSeamsBack(e,t,r){let n=new Uint32Array(t*r),a=0;for(let i=t-1;i>=0;i--)for(let l=0;l<r;l++){let r=l*t+i;n[a]=e[r],a++}return n}function createStartingPosMatrix(e,t){let r=new Uint32Array(e*t);for(let n=0;n<t;n++)for(let t=0;t<e;t++)r[n*e+t]=n<<16|t;return r}function calculateSeamMatrix(e,t,r,n,a,i){let l=createStartingPosMatrix(n,a),o=new Uint32Array(n*a),f=-1;for(let u=0;u<n;u++)f=findSeam(e,t,r,l,o,u,n-u,a,n,a,f,i)}function findSeam(e,t,r,n,a,i,l,o,f,u,m,s){createSeamTable(e,a,l,o,f,m);let g=getSeamPath(a,n,i,findMinimumSeamColumn(a,l,o,f),l,o,f,u,s);return resizeMatrixes(g,e,n,o,f),updateEnergy(e,g,t,n,r,l,f),g[0]}function createSeamTable(e,t,r,n,a,i){for(let n=0;n<r;n++)t[n]=e[n];let l=i>-1?i:99999;for(let o=1;o<n;o++){let n=(o-1)*a,f=o*a,u=Math.max(i-o-1,0),m=Math.min(l+o-1,r-1);0===u&&(t[f]=e[f]+Math.min(t[n],t[n+1]),u+=1),m===r-1&&(t[f+m]=e[f+m]+Math.min(t[n+m-1],t[n+m]),m-=1);for(let r=u;r<=m;r++){let a=n+r,i=f+r;t[i]=e[i]+minimum(t[a-1],t[a],t[a+1])}}return t}function findMinimumSeamColumn(e,t,r,n){let a=0,i=(r-1)*n;for(let r=0;r<t;r++){e[i+r]<e[i+a]&&(a=r)}return a}function resizeMatrixes(e,t,r,n,a){for(let i=0;i<n;i++){let n=i*a,l=n+e[i],o=l+1,f=n+a;t.copyWithin(l,o,f),r.copyWithin(l,o,f)}}function getSeamPath(e,t,r,n,a,i,l,o,f){let u=new Uint32Array(i),m=new Uint32Array(2*i+1);m[0]=f;let s=1;for(let g=i-1;g>0;g--){let i=t[g*l+n],c=i>>16,y=65535&i;u[g]=n,m[s]=0===f?c*l+y:(l-y-1)*o+c,m[s+1]=r,n=getNextMinCol(e,g,n,a,l),s+=2}u[0]=n;let g=t[n]>>16,c=65535&t[n];return m[s]=0===f?g*l+c:(l-c-1)*o+g,m[s+1]=r,postMessage(m.buffer,[m.buffer]),u}function getNextMinCol(e,t,r,n,a){let i=(t-1)*a,l=i+r,o=r;return r>0&&e[l-1]<e[i+o]&&(o=r-1),r<n-1&&e[l+1]<e[i+o]&&(o=r+1),o}function maybeApplyMask(e,t,r){let n=t[r];return 2516582655===n?(e[r]=0,!0):2516647680===n&&(e[r]=9999999,!0)}function getGreyscale(e){let t=new Uint8Array(e.width*e.height),r=e.data,n=r.length;for(let e=0;e<n;e+=4){let n=r[e],a=r[e+1],i=r[e+2];t[e/4]=.2126*n+.7152*a+.0722*i}return t}function updateEnergy(e,t,r,n,a,i,l){for(let o=1;o<t.length;o++){let f=t[o];setOffsettedForwardEnergy(r,n,e,a,o,Math.max(f-1,0),i,l),setOffsettedForwardEnergy(r,n,e,a,o,Math.min(f,i-1),i,l),setOffsettedForwardEnergy(r,n,e,a,o,Math.min(f+1,i-1),i,l)}}function getTruePos(e,t,r,n){let a=e[t*n+r];return(a>>16)*n+(65535&a)}function setOffsettedForwardEnergy(e,t,r,n,a,i,l,o){let f=a*o+i;if(maybeApplyMask(r,n,getTruePos(t,a,i,o)))return;let u=getTruePos(t,a-1,i,o),m=getTruePos(t,a,i-1,o),s=getTruePos(t,a,i+1,o),g=Math.abs(e[s]-e[m]),c=Math.abs(e[u]-e[m])+g,y=Math.abs(e[u]-e[s])+g;r[f]=Math.min(g,c,y)+99999}function setForwardEnergy(e,t,r,n,a,i){let l=n*i+a;if(maybeApplyMask(t,r,l))return!0;let o=(n-1)*i+a,f=l-1,u=l+1,m=Math.abs(e[u]-e[f]),s=Math.abs(e[o]-e[f])+m,g=Math.abs(e[o]-e[u])+m;return t[l]=Math.min(m,s,g)+99999,!1}function getForwardEnergyPixels(e,t,r,n){let a=new Uint32Array(e.length);for(let i=0;i<n;i++)for(let n=0;n<r;n++)setForwardEnergy(e,a,t,i,n,r);return a}function minimum(e,t,r){let n=e;return n>t&&(n=t),n>r&&(n=r),n}onmessage=function(e){generateNewSeamCarver(e.data.pixels,e.data.mask)};
