let completion=0;function generateNewSeamCarver(t,e){let a=t.width,n=t.height,r=performance.now(),i=getGreyscale(t),o=getForwardEnergyPixels(i,e,a,n),l=rotateGradientImage(i,a,n,"uint8"),s=getForwardEnergyPixels(l,e,n,a,"uint32");completion=0;let m=calculateSeamMatrix(o,i,e,a,n);console.log(performance.now()-r),postMessage({vSeamMatrix:m});let u=performance.now(),c=rotateSeamsBack(calculateSeamMatrix(s,l,e,n,a),n,a);console.log(performance.now()-u),postMessage({hSeamMatrix:c}),postMessage({completion:1})}function rotateGradientImage(t,e,a,n){let r="uint8"===n?new Uint8Array(e*a):new Uint32Array(e*a),i=0;for(let n=0;n<e;n++)for(let o=a-1;o>=0;o--){let a=o*e+n;r[i]=t[a],i++}return r}function rotateSeamsBack(t,e,a){let n=new Uint32Array(e*a),r=0;for(let i=e-1;i>=0;i--)for(let o=0;o<a;o++){let a=o*e+i;n[r]=t[a],r++}return n}function createStartingRowsColumnsMatrices(t,e){let a=new Uint32Array(t*e),n=new Uint32Array(t*e);for(let r=0;r<e;r++)for(let e=0;e<t;e++)a[r*t+e]=r,n[r*t+e]=e;return{startingRowsMatrix:a,startingColumnsMatrix:n}}function calculateSeamMatrix(t,e,a,n,r){let{startingRowsMatrix:i,startingColumnsMatrix:o}=createStartingRowsColumnsMatrices(n,r),l=new Uint32Array(n*r),s=new Uint32Array(n*r),m=-1;for(let u=0;u<n;u++)m=findSeam(t,e,a,i,o,l,s,u,n-u,r,n,m),(completion+=1)%10==0&&postMessage({completion:completion/(n+r)});return s}function findSeam(t,e,a,n,r,i,o,l,s,m,u,c){createSeamTable(t,i,s,m,u,c);let M=getSeamPath(i,o,n,r,l,findMinimumSeamColumn(i,s,m,u),s,m,u);return resizeMatrixes(M,t,e,n,r,m,u),updateEnergy(t,M,e,a,s),M[0]}function createSeamTable(t,e,a,n,r,i){for(let n=0;n<a;n++)e[n]=t[n];let o=i>-1?i:99999;for(let l=1;l<n;l++){let n=(l-1)*r,s=l*r,m=Math.max(i-l-1,0),u=Math.min(o+l-1,a-1);0===m&&(e[s]=t[s]+Math.min(e[n],e[n+1]),m+=1),u===a-1&&(e[s+u]=t[s+u]+Math.min(e[n+u-1],e[n+u]),u-=1);for(let a=m;a<=u;a++){let r=n+a,i=s+a;e[i]=t[i]+minimum(e[r-1],e[r],e[r+1])}}return e}function findMinimumSeamColumn(t,e,a,n){let r=0,i=(a-1)*n;for(let a=0;a<e;a++){t[i+a]<t[i+r]&&(r=a)}return r}function resizeMatrixes(t,e,a,n,r,i,o){for(let l=0;l<i;l++){let i=l*o,s=i+t[l],m=s+1,u=i+o;e.copyWithin(s,m,u),a.copyWithin(s,m,u),n.copyWithin(s,m,u),r.copyWithin(s,m,u)}}function getSeamPath(t,e,a,n,r,i,o,l,s){let m=new Uint32Array(l);for(let u=l-1;u>0;u--){let l=a[u*s+i],c=n[u*s+i];m[u]=i,e[l*s+c]=r,i=getNextMinCol(t,u,i,o,s)}return m[0]=i,e[n[i]]=r,m}function getNextMinCol(t,e,a,n,r){let i=(e-1)*r,o=i+a,l=a;return a>0&&t[o-1]<t[i+l]&&(l=a-1),a<n-1&&t[o+1]<t[i+l]&&(l=a+1),l}function maybeApplyMask(t,e,a){let n=e[a];return 2516582655===n?(t[a]=0,!0):2516647680===n&&(t[a]=999999,!0)}function getNewGradientMagnitude(t,e,a,n){let r=new Uint32Array(a*n);for(let i=0;i<n-1;i++){for(let n=0;n<a-1;n++){let o=i*a+n;if(maybeApplyMask(r,e,o))continue;let l=4*o,s=4*(o+1),m=4*((i+1)*a+n),u=Math.abs(t[s]-t[l])+Math.abs(t[s+1]-t[l+1])+Math.abs(t[s+2]-t[l+2]),c=Math.abs(t[m]-t[l])+Math.abs(t[m+1]-t[l+1])+Math.abs(t[m+2]-t[l+2]);r[o]=u+c+9999}let n=4*(i*a+a-1),o=4*((i+1)*a+a-1);maybeApplyMask(r,e,i*a+a-1)||(r[i*a+a-1]=Math.abs(t[o]-t[n])+Math.abs(t[o+1]-t[n+1])+Math.abs(t[o+2]-t[n+2])+9999)}let i=(n-1)*a;for(let n=0;n<a-1;n++){let a=4*(i+n),o=4*(i+n+1);maybeApplyMask(r,e,i+n)||(r[i+n]=Math.abs(t[o]-t[a])+Math.abs(t[o+1]-t[a+1])+Math.abs(t[o+2]-t[a+2])+9999)}return r}function getGreyscale(t){let e=new Uint8Array(t.width*t.height),a=t.data,n=a.length;for(let t=0;t<n;t+=4){let n=a[t],r=a[t+1],i=a[t+2];e[t/4]=.2126*n+.7152*r+.0722*i}return e}function updateEnergy(t,e,a,n,r){for(let i=1;i<e.length;i++){let o=e[i];setForwardEnergy(a,t,n,i,Math.max(o-1,0),r),setForwardEnergy(a,t,n,i,Math.min(o,r-1),r),setForwardEnergy(a,t,n,i,Math.min(o+1,r-1),r)}}function setForwardEnergy(t,e,a,n,r,i){let o=n*i+r;if(maybeApplyMask(e,a,o))return!0;let l=(n-1)*i+r,s=o-1,m=o+1,u=Math.abs(t[m]-t[s]),c=Math.abs(t[l]-t[s])+u,M=Math.abs(t[l]-t[m])+u;return e[o]=Math.min(u,c,M),!1}function getForwardEnergyPixels(t,e,a,n){let r=new Uint32Array(t.length);for(let i=0;i<n;i++)for(let n=0;n<a;n++)setForwardEnergy(t,r,e,i,n,a);return r}function minimum(t,e,a){let n=t;return n>e&&(n=e),n>a&&(n=a),n}onmessage=function(t){generateNewSeamCarver(t.data.pixels,t.data.mask)};
